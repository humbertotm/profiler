VAGRANTFILE_API_VERSION = '2'.freeze

# TODOS
# -- Forward host pub ssh key to vm without exposing any host machine details

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  # Box to be used to instantiate VM
  config.vm.box = 'ubuntu/xenial64'

  # Storage size
  config.disksize.size = '50GB'

  # https://github.com/hashicorp/vagrant/issues/8157
  config.vm.network 'forwarded_port', guest: 22, host: 2222, host_ip: '127.0.0.1', id: 'ssh'

  # Create a private network, which allows host-only access to the machine
  config.vm.network :private_network, ip: "192.168.50.4", type: 'dhcp'
  # Use 192.168.50.1 from within the guest to access the host
  # See https://stackoverflow.com/questions/16244601/vagrant-reverse-port-forwarding

  # Sync local folders to VM
  config.vm.synced_folder '.',                   '/vagrant',              type: 'nfs'
  config.vm.synced_folder '../screener-content', '/tmp/screener-content', type: 'nfs'

  config.vm.provider :virtualbox do |vb|
    # To fix DNS resolution issues
    vb.customize ['modifyvm', :id, '--natdnshostresolver1', 'on']

    # Use VBoxManage to customize the VM. For example to change memory:
    vb.customize ['modifyvm', :id, '--memory', '3072']
    vb.customize ['modifyvm', :id, '--cpus',        2]

    # Handle syncing the clock
    vb.customize ['guestproperty', 'set', :id, '/VirtualBox/GuestAdd/VBoxService/--timesync-set-threshold', 500]
  end
  
  # Run external install script
  config.vm.provision :shell, privileged: false, path: 'script/vm_setup.sh'

  # Move to /vagrnat upon sshing into the virtual machine
  config.ssh.extra_args = ['-t', 'cd /vagrant; bash --login']
end
